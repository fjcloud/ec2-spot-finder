#!/bin/bash
set -e

echo "---> Running custom assemble script"

# Show environment variables
echo "---> Environment variables:"
env

# Show current directory and contents
echo "---> Current directory: $(pwd)"
echo "---> Contents of current directory:"
ls -la

# Show contents of /tmp
echo "---> Contents of /tmp:"
ls -la /tmp

# If src directory exists, show its contents
if [ -d /tmp/src ]; then
  echo "---> Contents of /tmp/src:"
  ls -la /tmp/src
else
  echo "---> /tmp/src directory does not exist"
fi

# Copy source files to the working directory
echo "---> Copying source files to working directory"
rsync -av --delete /tmp/src/ ./

# Show contents of working directory after copy
echo "---> Contents of working directory after copy:"
ls -la

# Execute the default S2I script
echo "---> Executing default S2I assemble script"
/usr/libexec/s2i/assemble

# Ensure the static directory is copied
if [ -d ./static ]; then
  echo "---> Copying static files..."
  mkdir -p /opt/app-root/src/static
  rsync -av --delete ./static/ /opt/app-root/src/static/
  echo "---> Static files copied to /opt/app-root/src/static"
  ls -la /opt/app-root/src/static
else
  echo "---> Warning: static directory not found in the source"
  echo "---> Contents of the current directory:"
  ls -la
fi

echo "---> Assemble script completed"
